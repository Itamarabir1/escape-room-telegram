# זרימת משחק – בוט וקבוצה

מסמך זה מתאר מתי משתמש יכול להצטרף, איך משחק מתחיל ומסתיים, ומי יכול לבצע פעולות – בהתאם למקובל בתעשייה ולנוחות מקסימלית.

---

## מתי משתמש יכול להצטרף?

| מצב | איך מצטרף |
|-----|-----------|
| **במהלך ההרשמה** (אחרי `/start_game`, לפני "כולם פה") | לוחץ על "אני רוצה לשחק! 🙋‍♂️" – מתווסף לרשימת השחקנים. |
| **אחרי "כולם פה"** (המשחק כבר התחיל) | לוחץ על הכפתור "שחק עכשיו!" / "כניסה למשחק" בהודעה בקבוצה. בכניסה הראשונה ל-Web App הוא מתווסף אוטומטית לרשימת השחקנים (late join) ומקבל עדכונים בזמן אמת. |
| **נכנס לקבוצה אחרי שהמשחק התחיל** | אם הבוט שולח ברכת הצטרפות – יקבל הודעה עם כפתור "שחק עכשיו" ויוכל להצטרף בלחיצה. אחרת – יראה את ההודעות בקבוצה ויכול ללחוץ על הכפתור מההודעה "ההרשמה נסגרה!". |

**חובה ללחוץ על הקישור?**  
לא. הכפתור "שחק עכשיו" הוא Web App – הלחיצה פותחת את המשחק בתוך טלגרם (אותו קישור, אבל דרך הכפתור). אין צורך להעתיק קישור; הכפתור מופיע בהודעה אחרי "כולם פה".

---

## איך משחק מתחיל?

1. מישהו בקבוצה כותב **`/start_game`**.
2. הבוט שולח הודעה: "ההרפתקה מתחילה! מי מצטרף?" עם כפתורים:
   - **אני רוצה לשחק! 🙋‍♂️** – הרשמה.
   - **עשרת הגדולים ביותר** – לוח תוצאות.
3. שחקנים לוחצים "אני רוצה לשחק" (רשימת השחקנים מתעדכנת).
4. כשמוכנים – **כל חבר בקבוצה** יכול ללחוץ **"כולם פה, אפשר להתחיל! 🚀"**.
5. הבוט יוצר `game_id`, סוגר הרשמה, ושולח **הודעה חדשה** עם כפתור **"שחק עכשיו!"** (או "כניסה למשחק" כ-fallback). רק ההודעה הזו מכילה את הקישור למשחק (מאחורי הכפתור).

---

## מי יכול ללחוץ "כולם פה, אפשר להתחיל"?

**כל חבר בקבוצה** שרואה את ההודעה. אין הגבלה ל"רק מי שהריץ /start_game". כך קל להתארגן בקבוצה – כל מי שמוכן יכול לסגור הרשמה ולהתחיל.

---

## איך משחק מסתיים?

| אירוע | מה קורה |
|--------|---------|
| **טיימר הגיע ל-0** | ה-Web App שולח `time_up` ל-API; המשחק מסתיים, הבוט שולח בקבוצה: "הזמן נגמר! Game Over. כתבו /start_game כדי להתחיל מחדש." |
| **`/end_game`** | **רק מי שכתב `/start_game`** יכול להריץ `/end_game`. שאר החברים יקבלו: "רק מי שהתחיל את המשחק יכול לסיים אותו." |

---

## האם מישהו יכול להגדיר "לסיים משחק"?

כן, **אבל רק מי שהתחיל.** מי שכתב **`/start_game`** נשמר כ-`started_by_user_id` ב-`chat_data`. רק הוא יכול להריץ **`/end_game`** כדי לסיים את המשחק ידנית. כל משתמש אחר יקבל הודעה: "רק מי שהתחיל את המשחק (מי שכתב /start_game) יכול לסיים אותו."

---

## סיכום זרימה – דיאגרמה

```
/start_game
    → הודעה: "מי מצטרף?" + [אני רוצה לשחק] [עשרת הגדולים]
    → לחיצות "אני רוצה לשחק" מעדכנות רשימה

"כולם פה, אפשר להתחיל!"
    → נוצר game_id, הרשמה נסגרת
    → הודעה חדשה: כפתור "שחק עכשיו!" (Web App)

שחקן לוחץ כפתור
    → נכנס ל-Web App (אם לא היה רשום – מתווסף אוטומטית ב-API)
    → לוחץ "התחל" → טיימר מתחיל, חדר בריחה

סיום
    → טיימר 0: Game Over + הודעה בקבוצה
    → או: /end_game → משחק נגמר
```

---

## קבצים רלוונטיים

- **בוט:** `app/bot/handlers/game.py` – `/start_game`, callback "join_game", "start_ai_story", `/end_game`, welcome_new_member.
- **משחק ו-API:** `services/game_session.py` – הרשמה, `finish_registration`, `end_game_by_id`; `app/api/games.py` – `_get_game_and_require_player` (כולל late join).
- **WebSocket:** `app/api/ws_game.py` – חיבור לעדכונים; רק משתמשים שב-`game["players"]` (כולל מאוחרים שנוספו ב-API).
